# 4.3.2 Backend API Integration Documentation

## Overview
This document provides comprehensive documentation for the Backend API Integration section of the PWA Inspection Application, specifically focusing on Next.js Route Handlers that bridge the user interface with the AI inference engine.

---

## 1. Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                    FRONTEND LAYER                            │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  AICameraCapture.tsx (React Component)                 │ │
│  │  • Captures images via WebRTC camera API              │ │
│  │  • Provides multi-step guided capture flow            │ │
│  │  • Handles image compression and validation           │ │
│  └────────────────┬───────────────────────────────────────┘ │
└───────────────────┼───────────────────────────────────────────┘
                    │ HTTP POST /api/ai/analyze-extinguisher
                    │ Content-Type: application/json
                    │ Body: { images: CapturedImage[], extinguisherInfo: {...} }
                    ↓
┌─────────────────────────────────────────────────────────────┐
│                 NEXT.JS API LAYER (Backend)                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  /src/pages/api/ai/analyze-extinguisher.ts            │ │
│  │                                                         │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 1. Request Validation                            │ │ │
│  │  │    • Validate images array                       │ │ │
│  │  │    • Check request method (POST only)            │ │ │
│  │  │    • Validate body size (<10MB)                  │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  │                         ↓                              │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 2. Deployment Type Router                        │ │ │
│  │  │    • Read AI_DEPLOYMENT_TYPE from env            │ │ │
│  │  │    • Route to appropriate AI service             │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  │                         ↓                              │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 3. Service-Specific Handler                      │ │ │
│  │  │    • Transform request format                    │ │ │
│  │  │    • Call external AI service                    │ │ │
│  │  │    • Handle service-specific errors              │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  └───────────┬────────────────────────────────────────────┘ │
└──────────────┼──────────────────────────────────────────────┘
               │
    ┌──────────┴──────────┬──────────────┬──────────────┐
    ↓                     ↓              ↓              ↓
┌─────────┐         ┌──────────┐    ┌───────┐    ┌──────────┐
│Roboflow │         │ Digital  │    │  GCP  │    │  Azure   │
│   API   │         │  Ocean   │    │ Cloud │    │ Function │
│         │         │App Platform│   │  Run  │    │          │
└────┬────┘         └────┬─────┘    └───┬───┘    └────┬─────┘
     │                   │              │             │
     └───────────────────┴──────────────┴─────────────┘
                         │
                         │ Raw YOLO Detections
                         │ { results: [{ stepId, detections: [{class, confidence, bbox}] }] }
                         ↓
┌─────────────────────────────────────────────────────────────┐
│               DATA TRANSFORMATION LAYER                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  yoloDetectionMapper.ts                                │ │
│  │                                                         │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 1. Normalize Detections                          │ │ │
│  │  │    • Convert class names to standard format      │ │ │
│  │  │    • Filter by confidence threshold              │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  │                         ↓                              │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 2. Group by Component                            │ │ │
│  │  │    • shell, hose, nozzle, pressure_gauge, etc.   │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  │                         ↓                              │ │
│  │  ┌──────────────────────────────────────────────────┐ │ │
│  │  │ 3. Apply Business Logic                          │ │ │
│  │  │    • Map to inspection checklist fields          │ │ │
│  │  │    • Calculate pass/fail (√/X/NA)                │ │ │
│  │  │    • Generate reasoning text                     │ │ │
│  │  └──────────────────────────────────────────────────┘ │ │
│  └────────────────────┬───────────────────────────────────┘ │
└───────────────────────┼───────────────────────────────────────┘
                        │
                        │ AIInspectionResult (Type-Safe)
                        │ { success, detections[], extractedData, processingTime }
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                    RESPONSE TO FRONTEND                      │
│  • HTTP 200 OK                                              │
│  • Content-Type: application/json                           │
│  • Type-safe interface ensures compatibility                │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. Request/Response Flow

### 2.1 Request Flow

```
User Action
    ↓
[1] User captures images via AICameraCapture component
    ↓
[2] Frontend validates images (size, format, count)
    ↓
[3] Frontend prepares request payload:
    {
      images: [
        { stepId: 'overall', dataUrl: 'data:image/jpeg;base64,...', timestamp: 1234567890 },
        { stepId: 'closeup', dataUrl: 'data:image/jpeg;base64,...', timestamp: 1234567891 }
      ],
      extinguisherInfo: {
        serialNo: 'FE-001',
        location: 'Building A - Floor 2',
        typeSize: '9kg CO2'
      }
    }
    ↓
[4] POST request sent to /api/ai/analyze-extinguisher
    Headers: { 'Content-Type': 'application/json' }
    ↓
[5] Next.js API Route Handler receives request
    ↓
[6] Validation checks:
    ✓ Method is POST
    ✓ Images array exists and not empty
    ✓ Body size within limits
    ↓
[7] Route to AI service based on environment config
    ↓
[8] AI service processes images and returns detections
    ↓
[9] Map raw detections to inspection fields
    ↓
[10] Return structured response to frontend
```

### 2.2 Response Flow

```
Backend Processing Complete
    ↓
[1] AIInspectionResult object created
    ↓
[2] JSON serialization
    ↓
[3] HTTP response with status 200
    ↓
[4] Frontend receives response
    ↓
[5] Type validation (TypeScript)
    ↓
[6] UI updates with detection results
    ↓
[7] User reviews and can modify AI suggestions
```

---

## 3. Key Components

### 3.1 API Route Handler (`analyze-extinguisher.ts`)

**Location:** `src/pages/api/ai/analyze-extinguisher.ts`

**Purpose:** Main entry point for AI inference requests

**Key Features:**
- ✅ Multi-deployment support (Roboflow, DigitalOcean, GCP, Azure)
- ✅ Request validation and sanitization
- ✅ Error handling with user-friendly messages
- ✅ Processing time tracking
- ✅ Environment-based configuration
- ✅ Request timeout handling (30s default)
- ✅ Body size limits (10MB)
- ✅ Mock fallback for development/testing

**Code Structure:**
```typescript
// Main handler function
export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<AIInspectionResult>
) {
  // 1. Validate request method
  // 2. Extract and validate request body
  // 3. Route to appropriate AI service
  // 4. Map detections to inspection results
  // 5. Return response with metadata
}

// Service-specific handlers
async function detectWithRoboflow(images): Promise<YOLOImageResult[]>
async function detectWithDigitalOcean(images, info): Promise<YOLOImageResult[]>
async function detectWithGCP(images, info): Promise<YOLOImageResult[]>
async function detectWithAzure(images, info): Promise<YOLOImageResult[]>
```

### 3.2 Type Definitions (`ai-inspection.ts`)

**Location:** `src/types/ai-inspection.ts`

**Purpose:** Ensures type safety between frontend and backend

**Key Interfaces:**

```typescript
// Individual detection result for one checklist field
export interface AIDetectionResult {
  field: string;              // e.g., 'shell', 'hose', 'nozzle'
  value: '√' | 'X' | 'NA';   // Pass, Fail, Not Applicable
  confidence: number;         // 0-1 scale
  reasoning?: string;         // AI's explanation
}

// Complete inspection result
export interface AIInspectionResult {
  success: boolean;
  detections: AIDetectionResult[];
  extractedData: AIExtractedData;
  visualizations?: {
    stepId: string;
    annotatedImage: string;
    detectedComponents: string[];
  }[];
  processingTime?: number;
  error?: string;
}

// Captured image from camera
export interface CapturedImage {
  stepId: string;
  dataUrl: string;
  timestamp: number;
}
```

### 3.3 Detection Mapper (`yoloDetectionMapper.ts`)

**Location:** `src/utils/yoloDetectionMapper.ts`

**Purpose:** Transforms raw YOLO detections into business logic

**Key Functions:**

```typescript
// Main mapping function
export function mapYOLOToInspectionResults(
  yoloResults: YOLOImageResult[],
  images: CapturedImage[]
): AIInspectionResult

// Helper functions
function groupByComponent(detections: YOLODetection[]): Record<string, YOLODetection[]>
function average(numbers: number[]): number
export function meetsConfidenceThreshold(detection: YOLODetection, threshold: number): boolean
export function filterLowConfidence(detections: YOLODetection[], minConfidence: number): YOLODetection[]
export function getDetectionStats(detections: YOLODetection[])
```

**Business Logic Examples:**

1. **Shell Condition:**
   - Confidence > 0.85 → ✓ "Shell detected with 92% confidence - appears intact"
   - Confidence 0.75-0.85 → ✓ "Shell detected - condition acceptable"
   - Confidence < 0.75 → ✗ "Shell detected with low confidence - needs verification"
   - Not detected → ✗ "Shell not detected in image"

2. **Accessibility Inference:**
   - If ALL 6 core components detected with avg confidence > 0.85 → ✓ "Appears accessible"
   - If all detected but confidence 0.70-0.85 → ✓ "Likely accessible"
   - If some components missing → NA "Manual verification required"

---

## 4. Configuration & Environment Variables

### Required Environment Variables

```bash
# Deployment type selection
AI_DEPLOYMENT_TYPE=roboflow  # Options: roboflow | digitalocean | gcp | azure

# Roboflow configuration
ROBOFLOW_API_KEY=your_api_key_here
ROBOFLOW_MODEL_ENDPOINT=https://detect.roboflow.com/your-model/version

# DigitalOcean configuration
AI_MODEL_ENDPOINT=http://localhost:8000  # Internal endpoint

# GCP configuration
GCP_CLOUD_RUN_ENDPOINT=https://your-service.run.app

# Azure configuration
AZURE_FUNCTION_ENDPOINT=https://your-function.azurewebsites.net/api/detect

# Performance tuning
AI_MIN_CONFIDENCE=0.5        # Minimum detection confidence (0-1)
AI_TIMEOUT_MS=30000          # Request timeout in milliseconds
```

### API Configuration

```typescript
// From analyze-extinguisher.ts
export const config = {
  api: {
    bodyParser: {
      sizeLimit: '10mb',  // Maximum request body size
    },
  },
};
```

---

## 5. Error Handling Strategy

### 5.1 Client-Side Validation Errors (HTTP 400)

```typescript
// No images provided
{
  "success": false,
  "detections": [],
  "extractedData": {},
  "error": "No images provided"
}

// Invalid image format
{
  "success": false,
  "detections": [],
  "extractedData": {},
  "error": "Invalid image format"
}
```

### 5.2 Server-Side Errors (HTTP 500)

```typescript
// AI service unavailable
{
  "success": false,
  "detections": [],
  "extractedData": {},
  "error": "Failed to analyze images",
  "processingTime": 1234
}

// Timeout error
{
  "success": false,
  "detections": [],
  "extractedData": {},
  "error": "Request timeout - AI service took too long to respond",
  "processingTime": 30000
}
```

### 5.3 Method Not Allowed (HTTP 405)

```typescript
// GET request to POST-only endpoint
{
  "success": false,
  "detections": [],
  "extractedData": {},
  "error": "Method not allowed"
}
```

---

## 6. Sample API Request/Response

### 6.1 Request Example

```http
POST /api/ai/analyze-extinguisher HTTP/1.1
Host: localhost:3000
Content-Type: application/json

{
  "images": [
    {
      "stepId": "overall",
      "dataUrl": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD...",
      "timestamp": 1703001234567
    },
    {
      "stepId": "closeup",
      "dataUrl": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD...",
      "timestamp": 1703001245678
    }
  ],
  "extinguisherInfo": {
    "serialNo": "FE-001",
    "location": "Building A - Floor 2 - Near Stairwell",
    "typeSize": "9kg CO2"
  }
}
```

### 6.2 Response Example (Success)

```json
{
  "success": true,
  "detections": [
    {
      "field": "shell",
      "value": "√",
      "confidence": 0.92,
      "reasoning": "Shell detected with 92% confidence - appears intact"
    },
    {
      "field": "hose",
      "value": "√",
      "confidence": 0.88,
      "reasoning": "Hose detected at 88% confidence - clearly visible and attached"
    },
    {
      "field": "nozzle",
      "value": "√",
      "confidence": 0.85,
      "reasoning": "Nozzle detected at 85% confidence - clearly visible and attached"
    },
    {
      "field": "pressureGauge",
      "value": "√",
      "confidence": 0.95,
      "reasoning": "Pressure gauge detected at 95% confidence - clearly readable"
    },
    {
      "field": "emptyPressureLow",
      "value": "√",
      "confidence": 0.855,
      "reasoning": "Pressure gauge visible at 95% confidence - appears in operational range"
    },
    {
      "field": "safetyPin",
      "value": "√",
      "confidence": 0.9,
      "reasoning": "Safety pin detected at 90% confidence - clearly in place"
    },
    {
      "field": "pinSeal",
      "value": "√",
      "confidence": 0.87,
      "reasoning": "Pin seal detected at 87% confidence - clearly intact"
    },
    {
      "field": "servicingTags",
      "value": "√",
      "confidence": 0.91,
      "reasoning": "Service tag detected at 91% confidence - clearly readable"
    },
    {
      "field": "accessible",
      "value": "√",
      "confidence": 0.896666,
      "reasoning": "All components clearly visible at 90% confidence - appears accessible with no obstructions"
    },
    {
      "field": "missingNotInPlace",
      "value": "X",
      "confidence": 0.8,
      "reasoning": "Mounting bracket not visible, may not be in designated location"
    }
  ],
  "extractedData": {},
  "processingTime": 1847
}
```

---

## 7. Performance Metrics

### 7.1 Typical Performance

| Metric | Value |
|--------|-------|
| Average Response Time | 1.5 - 3.0 seconds |
| Image Processing Time | 800ms - 1.5s per image |
| Network Latency | 200ms - 500ms |
| Total API Time | 1.8 - 3.5 seconds |

### 7.2 Request Size

| Component | Size |
|-----------|------|
| Single Image (compressed) | 200KB - 800KB |
| Two Images | 400KB - 1.6MB |
| JSON Overhead | ~500 bytes |
| Total Request | 400KB - 2MB |

### 7.3 Response Size

| Component | Size |
|-----------|------|
| Detection Results | 1KB - 3KB |
| Metadata | ~200 bytes |
| Total Response | 1.2KB - 3.5KB |

---

## 8. Security Considerations

### 8.1 Input Validation
- ✅ Request method validation (POST only)
- ✅ Body size limits (10MB max)
- ✅ Image format validation (base64 data URLs)
- ✅ Array length validation

### 8.2 Error Handling
- ✅ No sensitive data in error messages
- ✅ Generic error responses for security
- ✅ Server-side logging for debugging

### 8.3 Rate Limiting
- ⚠️ Consider implementing rate limiting for production
- ⚠️ Consider API key authentication for external AI services

---

## 9. Testing Strategy

### 9.1 Unit Tests
- Test individual detection mappers
- Test confidence threshold logic
- Test error handling paths

### 9.2 Integration Tests
- Test full API flow with mock data
- Test each deployment type
- Test timeout scenarios

### 9.3 Manual Testing
- Test with real fire extinguisher images
- Test with various lighting conditions
- Test with partially obscured equipment

---

## 10. Future Enhancements

### 10.1 OCR Integration
- Extract expiry dates from service tags
- Extract serial numbers from labels
- Extract manufacturing dates

### 10.2 Visual Annotations
- Return annotated images with bounding boxes
- Highlight detected components
- Visual confidence indicators

### 10.3 Advanced Analytics
- Track detection accuracy over time
- Model performance monitoring
- A/B testing different models

### 10.4 Real-time Processing
- WebSocket support for live feedback
- Progressive image analysis
- Real-time camera guidance

---

## 11. Summary

The Backend API Integration successfully bridges the user interface with the AI inference engine through:

1. **Type-Safe Interfaces** - TypeScript ensures data consistency
2. **Flexible Architecture** - Support for multiple AI deployment options
3. **Robust Error Handling** - Graceful degradation and user-friendly errors
4. **Performance Optimization** - Request timeouts, body size limits
5. **Business Logic Layer** - Transforms raw AI detections into actionable insights
6. **Production-Ready** - Environment-based configuration, comprehensive logging

The architecture demonstrates industry best practices for building scalable, maintainable AI-powered APIs in a Next.js application.
