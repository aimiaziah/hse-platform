// HSE Inspection Checklist Export
// Creates Excel file from scratch with complete inspection data

import * as XLSX from 'xlsx';

/**
 * Interface for HSE Inspection data
 */
export interface HSEInspectionChecklistData {
  contractor: string;
  location: string;
  date: string;
  inspectedBy: string;
  workActivity: string;
  tablePersons: Array<{
    no: number;
    name: string;
    designation: string;
    signature: string;
  }>;
  inspectionItems: Array<{
    key: string;
    categoryId: number;
    item: string;
    rating: string | null;
    comment: string;
  }>;
}

/**
 * Category definitions matching the form
 */
const categories = [
  {
    id: 1,
    name: 'WORKING AREAS',
    items: ['Housekeeping', 'Proper barrier/ safety signs', 'Lighting adequacy', 'Site layout arrangement', 'Ventilation', 'Floor/ ground-edge/ opening condition', 'Escape/ working route condition', 'Material storage/ stacking']
  },
  {
    id: 2,
    name: 'SITE OFFICE',
    items: ['Office ergonomics', 'Location and maintenance', 'Fire extinguishers condition', 'First aid box facility', "Worker's legality / age", 'Green card (CIDB)/ NIOSH cert.', 'PMA/ PMT/ JBE/ DOE approval', 'Competent scaffolder']
  },
  {
    id: 3,
    name: 'HOT WORK/ ELECTRICAL',
    items: ['Gas cylinders secured and upright', 'Gauge functionality', 'Flashback arrestors availability', 'Cables insulation/ earthing', 'Wiring condition-plugs, joints, DB']
  },
  {
    id: 4,
    name: 'PERSONAL PROTECTIVE EQUIPMENT',
    items: ['Safety helmets', 'Safety footwear', 'Safety vest', 'Proper attire', 'Other; as per job requirements']
  },
  {
    id: 5,
    name: 'EXCAVATIONS',
    items: ['Safely secured-sign, barrier covered', 'No material at 1m from edge', 'Proper & adequate access & egress', 'Adequate slope protection', 'Check for underground hazard', 'Inspection checklist']
  },
  {
    id: 6,
    name: 'SCAFFOLDING',
    items: ['PE design requirement', 'Access condition', 'Walkways/ platform condition', 'Adequate slope protection', 'Means of fall protection', 'Ground/base condition', 'Inspection checklist']
  },
  {
    id: 7,
    name: 'MACHINERY & PLANT',
    items: ['Machinery guarding', 'Machinery/ plant service record', 'Properly and safely sited', 'Skid tank condition', 'Lifting process/ gear condition', "Vehicle's condition"]
  },
  {
    id: 8,
    name: 'TRAFFIC MANAGEMENT',
    items: ['Flagman availability & adequacy', 'Signages availability & adequacy', 'Vehicle route maintenance', 'Public road maintenance', 'Loads protection', 'Method of controlling']
  },
  {
    id: 9,
    name: 'HEALTH',
    items: ['First aid box/ facility', 'First aider availability', 'Vector/ Pest control', 'Washing/ clean water facility', 'Toilet condition / availability']
  },
  {
    id: 10,
    name: 'ENVIRONMENTAL',
    items: ['Control of oil pollution', 'Control of dust pollution / emission', 'Control of noise pollution / emission', 'Control of open burning', 'Control of debris / rubbish', 'Silt trap/drainage/culvert maintenance']
  },
  {
    id: 11,
    name: 'SECURITY',
    items: ['Security personal adequacy', 'Security sign condition/ availability', 'Control of site access/ exit', 'Hoarding/ fencing condition', 'Emergency contact list']
  },
  {
    id: 12,
    name: 'PUBLIC SAFETY',
    items: ['Warning signs', 'Control of public entry', 'Proper work planning toward public safety', 'Communication establishment', 'Training on public safety to worker', 'Catch platform', 'Pedestrian protection']
  },
];

/**
 * Generate HSE Inspection Checklist Excel document
 */
export function generateHSEInspectionChecklistDocument(data: HSEInspectionChecklistData): void {
  try {
    const wb = XLSX.utils.book_new();

    // Prepare header rows
    const headerRows: any[][] = [
      ['HSE INSPECTION CHECKLIST'],
      ['Theta Edge Berhad'],
      [],
      ['CONTRACTOR:', data.contractor, '', '', '', '', '', '', '', 'DATE:', data.date],
      ['LOCATION:', data.location, '', '', '', '', '', '', '', 'INSPECTED BY:', data.inspectedBy],
      ['WORK ACTIVITY:', data.workActivity],
      [],
      ['LEGEND: G = Good  |  A = Acceptable  |  P = Poor  |  I = Irrelevant  |  SIN = Safety Improvement Notice  |  SPS = Safety Penalty System  |  SWO = Stop Work Order'],
      [],
    ];

    // Add personnel section
    if (data.tablePersons.length > 0) {
      headerRows.push(['Personnel Involved:']);
      headerRows.push(['No.', 'Name', 'Designation', 'Signature']);
      data.tablePersons.forEach(person => {
        if (person.name || person.designation) {
          headerRows.push([
            person.no,
            person.name,
            person.designation,
            person.signature ? 'Signed' : ''
          ]);
        }
      });
      headerRows.push([]);
    }

    headerRows.push(['INSPECTION ITEMS']);
    headerRows.push([]);

    // Build inspection items table with tick marks
    const inspectionRows: any[][] = [];

    categories.forEach(category => {
      // Category header
      inspectionRows.push([`${category.id}. ${category.name}`]);
      inspectionRows.push(['Item', 'G', 'A', 'P', 'I', 'SIN', 'SPS', 'SWO', 'Comments']);

      // Category items
      category.items.forEach(item => {
        const key = `${category.id}-${item}`;
        const itemData = data.inspectionItems.find(i => i.key === key);
        const rating = itemData?.rating;
        const comment = itemData?.comment || '';

        inspectionRows.push([
          item,
          rating === 'G' ? '✓' : '',
          rating === 'A' ? '✓' : '',
          rating === 'P' ? '✓' : '',
          rating === 'I' ? '✓' : '',
          rating === 'SIN' ? '✓' : '',
          rating === 'SPS' ? '✓' : '',
          rating === 'SWO' ? '✓' : '',
          comment
        ]);
      });

      // Empty row between categories
      inspectionRows.push([]);
    });

    // Add Comments/Remarks section
    inspectionRows.push([]);
    inspectionRows.push(['Comments/Remarks:']);
    inspectionRows.push(['']);
    inspectionRows.push(['']);
    inspectionRows.push(['']);
    inspectionRows.push(['']);
    inspectionRows.push(['________________________________________________________________________________']);

    // Combine all rows
    const allRows = [...headerRows, ...inspectionRows];

    // Create worksheet
    const ws = XLSX.utils.aoa_to_sheet(allRows);

    // Set column widths
    ws['!cols'] = [
      { wch: 40 },  // Item
      { wch: 5 },   // G
      { wch: 5 },   // A
      { wch: 5 },   // P
      { wch: 5 },   // I
      { wch: 6 },   // SIN
      { wch: 6 },   // SPS
      { wch: 6 },   // SWO
      { wch: 40 },  // Comments
    ];

    // Add worksheet to workbook
    XLSX.utils.book_append_sheet(wb, ws, 'HSE Inspection Checklist');

    // Generate filename
    const filename = `HSE_Inspection_Checklist_${data.location.replace(/[^a-z0-9]/gi, '_')}_${data.date}.xlsx`;

    // Download file
    XLSX.writeFile(wb, filename);

    console.log('HSE Inspection Checklist downloaded successfully');
  } catch (error) {
    console.error('Error generating HSE Inspection checklist:', error);
    alert('Failed to generate HSE Inspection Checklist. Please try again.');
  }
}

/**
 * Download the HSE Inspection Checklist (Legacy - creates from scratch)
 */
export async function downloadHSEInspectionChecklist(
  formData: HSEInspectionChecklistData,
  filename?: string,
): Promise<void> {
  try {
    generateHSEInspectionChecklistDocument(formData);
  } catch (error) {
    console.error('Error downloading HSE Inspection checklist:', error);
    alert('Failed to download HSE Inspection Checklist. Please try again.');
    throw error;
  }
}

/**
 * Download HSE Inspection Checklist using template from Supabase Storage
 */
export async function downloadHSEInspectionChecklistWithTemplate(
  formData: HSEInspectionChecklistData & { commentsRemarks?: string },
  format: 'excel' | 'pdf' = 'excel',
): Promise<void> {
  try {
    // Call the API endpoint to generate the filled template
    const response = await fetch('/api/export/hse-inspection-template', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        ...formData,
        format,
      }),
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.message || `Failed to generate export: ${response.statusText}`);
    }

    // Get the blob from response
    const blob = await response.blob();

    // Generate filename
    const extension = format === 'pdf' ? 'pdf' : 'xlsx';
    const filename = `HSE_Inspection_Checklist_${formData.location.replace(/[^a-z0-9]/gi, '_')}_${formData.date}.${extension}`;

    // Create download link
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();

    // Cleanup
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);

    console.log('HSE Inspection Checklist downloaded successfully');
  } catch (error) {
    console.error('Error downloading HSE Inspection checklist with template:', error);
    alert('Failed to download HSE Inspection Checklist. Please try again.');
    throw error;
  }
}
